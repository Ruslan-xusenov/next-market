{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="cart-page" style="margin-top: 30px;">
    <h1 style="font-size: 24px; font-weight: 800; margin-bottom: 30px;">Savat</h1>

    {% if cart_items %}
    <div class="cart-layout">
        <div class="cart-items-container">
            <div
                style="background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: 20px; overflow: hidden;">
                {% for cart_item in cart_items %}
                <div class="cart-item" id="cart-item-{{ cart_item.id }}">
                    <div
                        style="width: 100px; height: 130px; background: #111; border-radius: 12px; overflow: hidden; flex-shrink: 0;">
                        {% if cart_item.product.image %}
                        <img src="{{ cart_item.product.image.url }}" alt="{{ cart_item.product.name }}"
                            style="width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                        <img src="https://via.placeholder.com/100x130" alt="{{ cart_item.product.name }}"
                            style="width: 100%; height: 100%; object-fit: cover;">
                        {% endif %}
                    </div>
                    <div class="cart-item-info"
                        style="flex: 1; display: flex; flex-direction: column; justify-content: space-between;">
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <h3 style="font-weight: 600; color: white; margin: 0;">{{ cart_item.product.name }}</h3>
                                <a href="{% url 'market:remove_from_cart' cart_item.pk %}"
                                    style="color: var(--text-gray); font-size: 18px; transition: 0.2s;"
                                    onmouseover="this.style.color='red'"
                                    onmouseout="this.style.color='var(--text-gray)'">
                                    <i class="far fa-trash-alt"></i>
                                </a>
                            </div>
                        </div>

                        <div
                            style="display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 15px;">
                            <div
                                style="display: flex; align-items: center; gap: 15px; background: #111; border: 1px solid #222; padding: 8px 15px; border-radius: 10px;">
                                <span style="font-size: 18px; cursor: pointer; color: var(--text-gray);"
                                    onclick="updateQuantity({{ cart_item.id }}, 'decrement')">-</span>
                                <span id="qty-{{ cart_item.id }}"
                                    style="font-weight: 800; color: white; min-width: 20px; text-align: center;">{{ cart_item.quantity }}</span>
                                <span style="font-size: 18px; cursor: pointer; color: var(--primary-yellow);"
                                    onclick="updateQuantity({{ cart_item.id }}, 'increment')">+</span>
                            </div>
                            <div style="text-align: right;">
                                <div id="price-{{ cart_item.id }}"
                                    style="font-size: 18px; font-weight: 800; color: var(--primary-yellow);">{{ cart_item.total_price|floatformat:0 }} so'm</div>
                                {% if cart_item.product.old_price %}
                                <div style="font-size: 14px; color: var(--text-gray); text-decoration: line-through;">{{ cart_item.product.old_price|floatformat:0 }} so'm</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="cart-summary-container">
            <div class="cart-summary">
                <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 25px; color: white;">Sizning buyurtmangiz
                </h3>
                <div
                    style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 15px; color: var(--text-gray);">
                    <span>Mahsulotlar (<span id="summary-count">{{ cart_items|length }}</span>):</span>
                    <span style="color: white;" class="total-price-display">{{ total_price|floatformat:0 }} so'm</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; margin-bottom: 25px; font-size: 15px; color: var(--text-gray);">
                    <span>Yetkazib berish:</span>
                    <span style="color: #22c55e; font-weight: 700;">Bepul</span>
                </div>
                <hr style="border: none; border-top: 1px dashed var(--dark-border); margin-bottom: 25px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                    <span style="font-weight: 700; font-size: 18px; color: white;">Jami:</span>
                    <span style="font-weight: 900; font-size: 24px; color: var(--primary-yellow);"
                        class="total-price-display">{{ total_price|floatformat:0 }} so'm</span>
                </div>
                <a href="{% url 'market:checkout' %}" class="btn-white"
                    style="display: block; width: 100%; text-align: center; padding: 18px; border-radius: 12px; font-size: 17px; text-decoration: none;">Rasmiylashtirish</a>
            </div>
        </div>
    </div>
    {% else %}
    <div
        style="text-align: center; padding: 120px 0; background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: 28px; border-style: dashed;">
        <i class="fas fa-shopping-cart" style="font-size: 80px; color: var(--dark-border); margin-bottom: 30px;"></i>
        <h2 style="font-size: 26px; font-weight: 800; margin-bottom: 15px; color: white;">Savatda hozircha mahsulot yoʻq
        </h2>
        <p style="color: var(--text-gray); margin-bottom: 40px; font-size: 15px;">Bosh sahifadagi toʻplamlardan boshlang
            yoki kerakli mahsulotni qidiruv orqali toping</p>
        <a href="{% url 'market:home' %}" class="btn-yellow-main" style="padding: 15px 40px; font-size: 16px;">Bosh
            sahifaga</a>
    </div>
    {% endif %}
</div>

<script>
    async function updateQuantity(itemId, action) {
        const formData = new FormData();
        formData.append('action', action);

        try {
            const response = await fetch(`/api/cart/update/${itemId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            });

            const data = await response.json();

            if (data.status === 'ok') {
                document.getElementById(`qty-${itemId}`).innerText = data.quantity;
                document.getElementById(`price-${itemId}`).innerText = data.total_price.toLocaleString() + " so'm";
                updateCartTotals();
            } else if (data.status === 'removed') {
                document.getElementById(`cart-item-${itemId}`).remove();
                updateCartTotals();
                if (document.querySelectorAll('.cart-item').length === 0) {
                    location.reload();
                }
            }
        } catch (error) {
            console.error('Error updating quantity:', error);
        }
    }

    async function updateCartTotals() {
        try {
            const response = await fetch('/api/cart/get/');
            const data = await response.json();

            // Update all total price displays on page
            const totalDisplays = document.querySelectorAll('.total-price-display');
            totalDisplays.forEach(el => {
                el.innerText = Math.round(data.total_price).toLocaleString() + " so'm";
            });

            const countSummary = document.getElementById('summary-count');
            if (countSummary) countSummary.innerText = data.count;

            updateCartBadge(); // from base.html
        } catch (e) {
            console.error('Error updating totals:', e);
        }
    }
</script>
{% endblock %}
