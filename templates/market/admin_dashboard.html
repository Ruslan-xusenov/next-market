{% extends 'market/admin_base.html' %}
{% load static %}

{% block admin_content %}
<style>
    .stats-grid {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .stat-card {
        flex: 1;
        min-width: 200px;
        background: var(--admin-card);
        border: 1px solid var(--admin-border);
        border-radius: 16px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }

    .stat-info h4 {
        color: var(--text-dim);
        font-size: 13px;
        margin-bottom: 5px;
    }

    .stat-info .value {
        font-size: 22px;
        font-weight: 800;
    }

    .admin-main-card {
        background: var(--admin-card);
        border-radius: 16px;
        border: 1px solid var(--admin-border);
        padding: 25px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .products-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .products-table th {
        text-align: left;
        padding: 15px 20px;
        color: #888;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        border-bottom: 1px solid var(--admin-border);
        letter-spacing: 0.5px;
    }

    .products-table td {
        padding: 15px 20px;
        color: white !important;
        border-bottom: 1px solid var(--admin-border);
        vertical-align: middle;
    }

    .order-items-list {
        font-size: 12px;
        color: #777;
        margin-top: 8px;
        line-height: 1.4;
    }

    .order-items-list span {
        background: rgba(255, 255, 255, 0.05);
        padding: 2px 6px;
        border-radius: 4px;
        margin-right: 4px;
        display: inline-block;
        margin-bottom: 4px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Table Column Widths */
    .products-table th:nth-child(1) {
        width: 60px;
    }

    .products-table th:nth-child(2) {
        min-width: 150px;
    }

    .products-table th:nth-child(3) {
        min-width: 150px;
    }

    .products-table th:nth-child(5) {
        min-width: 250px;
    }
</style>

<!-- Stats Overview -->
<div class="stats-grid" id="stats-area">
    <div class="stat-card" onclick="switchTab('buyurtmalar')" style="cursor: pointer;">
        <div class="stat-icon" style="background: rgba(255, 215, 0, 0.1); color: var(--primary-yellow);">
            <i class="fas fa-shopping-bag"></i>
        </div>
        <div class="stat-info">
            <h4>Yangi buyurtmalar</h4>
            <div class="value">{{ orders_yangi.count }}</div>
        </div>
    </div>
    <div class="stat-card" onclick="switchTab('tasdiqlanganlar')" style="cursor: pointer;">
        <div class="stat-icon" style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-info">
            <h4>Tasdiqlangan</h4>
            <div class="value">{{ orders_tasdiqlangan.count }}</div>
        </div>
    </div>
    <div class="stat-card" onclick="switchTab('kuryer')" style="cursor: pointer;">
        <div class="stat-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
            <i class="fas fa-motorcycle"></i>
        </div>
        <div class="stat-info">
            <h4>Kuryer</h4>
            <div class="value">{{ orders_kuryer.count }}</div>
        </div>
    </div>
    <div class="stat-card" onclick="switchTab('mijozlar')" style="cursor: pointer;">
        <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-info">
            <h4>Mijozlar</h4>
            <div class="value">{{ users_list.count }}</div>
        </div>
    </div>
</div>

<!-- Main Content Area -->
<div class="admin-main-card">
    <!-- Buyurtmalar Tab -->
    <div class="tab-content" id="buyurtmalar" style="display: none;">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-shopping-bag" style="color: var(--primary-yellow);"></i>
                Yangi buyurtmalar
            </div>
            <i class="fas fa-sync-alt refresh-btn" onclick="location.reload()" style="cursor:pointer; color: #555;"></i>
        </div>

        {% if orders_yangi %}
        <div style="overflow-x: auto;">
            <table class="products-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>MIJOZ</th>
                        <th>ALOQA</th>
                        <th>SANA</th>
                        <th>TOVARLAR</th>
                        <th>SUMMA</th>
                        <th>AMALLAR</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders_yangi %}
                    <tr>
                        <td style="font-weight: 700;">#{{ order.id }}</td>
                        <td>
                            <div style="font-weight: 600;">{{ order.full_name }}</div>
                            {% if order.user %}<div style="font-size: 11px; color: #666;">@{{ order.user.username }}
                            </div>{% endif %}
                        </td>
                        <td>
                            <div style="font-size: 13px; color: var(--primary-yellow); font-weight: 700;">
                                {{ order.phone_number }}
                            </div>
                            <div style="font-size: 11px; color: #555;">{{ order.address|truncatechars:30 }}</div>
                            {% if order.user_note %}
                            <div
                                style="font-size: 11px; color: var(--primary-yellow); margin-top: 5px; font-style: italic;">
                                <i class="far fa-comment-dots"></i> {{ order.user_note }}
                            </div>
                            {% endif %}
                        </td>
                        <td style="font-size: 13px; color: #666;">{{ order.created_at|date:"d.m.Y H:i" }}</td>
                        <td style="text-align: left;">
                            <div style="font-weight: 700; color: #22c55e;">{{ order.items_count }} dona</div>
                            <div class="order-items-list">
                                {% for item in order.items.all %}
                                <span>{{ item.product.name }} ({{ item.quantity }})</span>
                                {% endfor %}
                            </div>
                        </td>
                        <td style="color: var(--primary-yellow); font-weight: 800;">
                            {{ order.total_amount|floatformat:0 }} so'm
                        </td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                <a href="{% url 'market:update_order_status' order.id 'tasdiqlangan' %}"
                                    title="Tasdiqlash"
                                    style="color: #22c55e; background: rgba(34, 197, 94, 0.1); padding: 8px; border-radius: 8px;"><i
                                        class="fas fa-check"></i></a>
                                <a href="{% url 'market:update_order_status' order.id 'bekor' %}" title="Bekor qilish"
                                    style="color: #ef4444; background: rgba(239, 68, 68, 0.1); padding: 8px; border-radius: 8px;"><i
                                        class="fas fa-times"></i></a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="admin-empty-state">
            <i class="fas fa-shopping-bag"></i>
            <p>Hozircha yangi buyurtmalar mavjud emas</p>
        </div>
        {% endif %}
    </div>

    <!-- Tovar boshqaruvi Tab -->
    <div class="tab-content" id="tovar">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-box-open" style="color: var(--primary-yellow);"></i>
                Mahsulotlar ro'yxat
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div class="tab-internal-search">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Qidiruv..." oninput="filterTable(this, 'products-table')">
                </div>
                <button class="btn-yellow-main" onclick="switchTab('qoshish')">
                    <i class="fas fa-plus"></i> Qo'shish
                </button>
            </div>
        </div>

        {% if products %}
        <div style="overflow-x: auto;">
            <table class="products-table">
                <thead>
                    <tr>
                        <th>RASM</th>
                        <th>NOMI</th>
                        <th>TOIFA</th>
                        <th>NARXI</th>
                        <th>AMALLAR</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td>
                            {% if product.image %}
                            <img src="{{ product.image.url }}"
                                style="width: 45px; height: 45px; object-fit: cover; border-radius: 6px;">
                            {% else %}
                            <div
                                style="width: 45px; height: 45px; background: #1a1a1a; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-image" style="color: #333;"></i>
                            </div>
                            {% endif %}
                        </td>
                        <td style="font-weight: 600;">{{ product.name }}</td>
                        <td style="color: #666;">{{ product.category.name }}</td>
                        <td style="color: var(--primary-yellow); font-weight: 700;">{{ product.price|floatformat:0 }}
                            so'm</td>
                        <td>
                            <div style="display: flex; gap: 12px;">
                                <a href="{% url 'market:admin_edit_product' product.pk %}" style="color: #aaa;"><i
                                        class="fas fa-edit"></i></a>
                                <a href="{% url 'market:admin_delete_product' product.pk %}" style="color: #551111;"
                                    onclick="return confirm('O\'chirishni xohlaysizmi?')">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>

    <!-- Tasdiqlanganlar Tab -->
    <div class="tab-content" id="tasdiqlanganlar" style="display: none;">
        <div class="section-header">
            <div class="section-title">Tasdiqlangan buyurtmalar ({{ orders_tasdiqlangan.count }})</div>
        </div>

        {% if orders_tasdiqlangan %}
        <div style="overflow-x: auto;">
            <table class="products-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>MIJOZ</th>
                        <th>ALOQA</th>
                        <th>SANA</th>
                        <th>TOVARLAR</th>
                        <th>SUMMA</th>
                        <th>AMALLAR</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders_tasdiqlangan %}
                    <tr>
                        <td style="font-weight: 700;">#{{ order.id }}</td>
                        <td>{{ order.full_name }}</td>
                        <td>
                            <span style="color: var(--primary-yellow); font-weight: 700;">
                                {{ order.phone_number }}
                            </span>
                            {% if order.user_note %}
                            <div
                                style="font-size: 11px; color: var(--primary-yellow); margin-top: 5px; font-style: italic;">
                                <i class="far fa-comment-dots"></i> {{ order.user_note }}
                            </div>
                            {% endif %}
                        </td>
                        <td style="font-size: 12px;">{{ order.updated_at|date:"d.m.Y H:i" }}</td>
                        <td style="text-align: left;">
                            <div style="font-weight: 700; color: #22c55e;">{{ order.items_count }} dona</div>
                            <div class="order-items-list">
                                {% for item in order.items.all %}
                                <span>{{ item.product.name }} ({{ item.quantity }})</span>
                                {% endfor %}
                            </div>
                        </td>
                        <td style="color: var(--primary-yellow); font-weight: 700;">
                            {{ order.total_amount|floatformat:0 }} so'm
                        </td>
                        <td>
                            <a href="{% url 'market:update_order_status' order.id 'kuryer' %}" title="Kuryerga berish"
                                style="color: #8b5cf6; background: rgba(139, 92, 246, 0.1); padding: 8px; border-radius: 8px;"><i
                                    class="fas fa-motorcycle"></i></a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="admin-empty-state">
            <i class="fas fa-shopping-bag"></i>
            <p>Tasdiqlangan buyurtmalar mavjud emas</p>
        </div>
        {% endif %}
    </div>

    <!-- Bekor Tab -->
    <div class="tab-content" id="bekor" style="display: none;">
        <div class="section-header">
            <div class="section-title">Bekor qilingan buyurtmalar ({{ orders_bekor.count }})</div>
        </div>

        {% if orders_bekor %}
        <div style="overflow-x: auto;">
            <table class="products-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>MIJOZ</th>
                        <th>ALOQA</th>
                        <th>TOVARLAR</th>
                        <th>SUMMA</th>
                        <th>SANA</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders_bekor %}
                    <tr>
                        <td>#{{ order.id }}</td>
                        <td>{{ order.full_name }}</td>
                        <td>{{ order.phone_number }}</td>
                        <td>{{ order.items_count }} dona</td>
                        <td>{{ order.total_amount|floatformat:0 }} so'm</td>
                        <td>{{ order.updated_at|date:"d.m.Y" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="admin-empty-state">
            <i class="fas fa-shopping-bag"></i>
            <p>Bekor qilingan buyurtmalar mavjud emas</p>
        </div>
        {% endif %}
    </div>

    <!-- Kuryer Tab -->
    <div class="tab-content" id="kuryer" style="display: none;">
        <div class="section-header">
            <div class="section-title">Kuryerdagi buyurtmalar ({{ orders_kuryer.count }})</div>
        </div>

        {% if orders_kuryer %}
        <div style="overflow-x: auto;">
            <table class="products-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>MIJOZ</th>
                        <th>ALOQA</th>
                        <th>TOVARLAR</th>
                        <th>SUMMA</th>
                        <th>AMALLAR</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders_kuryer %}
                    <tr>
                        <td>#{{ order.id }}</td>
                        <td>{{ order.full_name }}</td>
                        <td style="font-weight: 600;">{{ order.phone_number }}</td>
                        <td style="text-align: left;">
                            <div style="font-weight: 700; color: #22c55e;">{{ order.items_count }} dona</div>
                            <div class="order-items-list">
                                {% for item in order.items.all %}
                                <span>{{ item.product.name }} ({{ item.quantity }})</span>
                                {% endfor %}
                            </div>
                        </td>
                        <td style="color: var(--primary-yellow); font-weight: 700;">
                            {{ order.total_amount|floatformat:0 }} so'm
                        </td>
                        <td>
                            <a href="{% url 'market:update_order_status' order.id 'yetkazildi' %}"
                                title="Yetkazib berildi"
                                style="color: #22c55e; background: rgba(34, 197, 94, 0.1); padding: 8px 15px; border-radius: 8px; text-decoration: none; font-weight: 700; font-size: 13px;"><i
                                    class="fas fa-check-double"></i> Tugatish</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="admin-empty-state">
            <i class="fas fa-shopping-bag"></i>
            <p>Kuryerga berilgan buyurtmalar mavjud emas</p>
        </div>
        {% endif %}
    </div>

    <!-- Toifalar Tab -->
    <div class="tab-content" id="toifalar" style="display: none;">
        <div class="section-header">
            <div class="section-title">Yangi toifa</div>
        </div>

        <form action="{% url 'market:admin_add_category' %}" method="POST" enctype="multipart/form-data"
            style="display: flex; gap: 15px; align-items: center; background: #111; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #222;">
            {% csrf_token %}
            <div style="flex: 1;">
                <input type="text" name="name" placeholder="Toifa nomi"
                    style="width: 100%; background: transparent; border: 1px solid #333; padding: 12px; border-radius: 8px; color: white; outline: none;">
            </div>
            <button type="submit" class="btn-yellow-main" style="border: none; cursor: pointer;">
                Qo'shish
            </button>
        </form>

        <div class="section-title" style="margin-bottom: 20px; font-size: 16px;">Mavjud toifalar</div>
        {% if categories %}
        <table class="products-table">
            <thead>
                <tr>
                    <th>IKONA</th>
                    <th>NOMI</th>
                    <th>MAHSULOTLAR</th>
                    <th>AMALLAR</th>
                </tr>
            </thead>
            <tbody>
                {% for category in categories %}
                <tr>
                    <td>
                        {% if category.icon %}
                        <img src="{{ category.icon.url }}" style="width: 30px; height: 30px; object-fit: contain;">
                        {% else %}
                        <i class="fas fa-folder" style="color: #333;"></i>
                        {% endif %}
                    </td>
                    <td style="font-weight: 600;">{{ category.name }}</td>
                    <td style="color: #666;">{{ category.product_set.count }} dona</td>
                    <td>
                        <div style="display: flex; gap: 12px;">
                            <a href="{% url 'market:admin_edit_category' category.pk %}" style="color: #aaa;"><i
                                    class="fas fa-edit"></i></a>
                            <a href="{% url 'market:admin_delete_category' category.pk %}" style="color: #551111;"><i
                                    class="fas fa-trash"></i></a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="admin-empty-state">
            <i class="fas fa-list-ul"></i>
            <p>Hozircha toifalar mavjud emas</p>
        </div>
        {% endif %}
    </div>

    <!-- Bannerlar Tab -->
    <div class="tab-content" id="bannerlar" style="display: none;">
        <div class="section-header">
            <div class="section-title">Yangi banner qo'shish</div>
        </div>

        <form action="{% url 'market:admin_add_banner' %}" method="POST" enctype="multipart/form-data"
            style="background: #111; padding: 25px; border-radius: 12px; margin-bottom: 40px; border: 1px solid #222;">
            {% csrf_token %}
            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #555; font-size: 11px; margin-bottom: 8px;">Banner
                    sarlavhasi</label>
                <input type="text" name="title" placeholder="Masalan: Yangi Yil Aksiyasi"
                    style="width: 100%; background: #080808; border: 1px solid #222; padding: 12px; border-radius: 8px; color: white;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #555; font-size: 11px; margin-bottom: 8px;">Tavsif
                    (ixtiyoriy)</label>
                <input type="text" name="description" placeholder="Chegirmalar haqida ma'lumot"
                    style="width: 100%; background: #080808; border: 1px solid #222; padding: 12px; border-radius: 8px; color: white;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #555; font-size: 11px; margin-bottom: 8px;">Tugma matni</label>
                <input type="text" name="button_text" placeholder="Xarid qilish"
                    style="width: 100%; background: #080808; border: 1px solid #222; padding: 12px; border-radius: 8px; color: white;">
            </div>

            <div style="background: #080808; border: 2px dashed #222; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; margin-bottom: 20px;"
                onclick="document.getElementById('bannerImage').click()">
                <i class="fas fa-image" style="font-size: 30px; color: #333; margin-bottom: 15px;"></i>
                <p style="color: #666; font-size: 13px;">Banner rasmini tanlang</p>
                <input type="file" name="image" id="bannerImage" style="display: none;">
            </div>

            <div style="display: flex; justify-content: flex-end;">
                <button type="submit" class="btn-yellow-main" style="border: none; cursor: pointer;">Saqlash</button>
            </div>
        </form>

        <div class="section-title" style="margin-bottom: 20px; font-size: 16px;">Mavjud bannerlar</div>
        {% if banners %}
        <table class="products-table">
            <thead>
                <tr>
                    <th>RASM</th>
                    <th>SARLOHA</th>
                    <th>HOLAT</th>
                    <th>AMALLAR</th>
                </tr>
            </thead>
            <tbody>
                {% for banner in banners %}
                <tr>
                    <td>
                        <img src="{{ banner.image.url }}"
                            style="width: 100px; height: 40px; object-fit: cover; border-radius: 4px;">
                    </td>
                    <td style="font-weight: 600;">{{ banner.title }}</td>
                    <td>
                        <span
                            class="status-badge {% if banner.is_active %}status-active{% else %}status-inactive{% endif %}">
                            {% if banner.is_active %}FAOL{% else %}NOFAOL{% endif %}
                        </span>
                    </td>
                    <td>
                        <div style="display: flex; gap: 12px;">
                            <a href="{% url 'market:admin_edit_banner' banner.pk %}" style="color: #aaa;"><i
                                    class="fas fa-edit"></i></a>
                            <a href="{% url 'market:admin_delete_banner' banner.pk %}" style="color: #551111;"><i
                                    class="fas fa-trash"></i></a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="admin-empty-state">
            <i class="far fa-image"></i>
            <p>Hozircha bannerlar mavjud emas</p>
        </div>
        {% endif %}
    </div>

    <!-- Mijozlar Tab -->
    <div class="tab-content" id="mijozlar" style="display: none;">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-users" style="color: var(--primary-yellow);"></i>
                Mijozlar ro'yxati
            </div>
            <div class="tab-internal-search">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Ism, email yoki telefon bo'yicha qidirish..."
                    oninput="filterTable(this, 'users-table')">
            </div>
        </div>

        {% if users_list %}
        <div style="overflow-x: auto;">
            <table class="products-table users-table">
                <thead>
                    <tr>
                        <th>MIJOZ</th>
                        <th>ALOQA</th>
                        <th>SANA</th>
                        <th>SAVAT</th>
                        <th>SARALANGAN</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in users_list %}
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="p-circle"
                                    style="width: 30px; height: 30px; font-size: 12px; border-radius: 8px;">
                                    {{ u.username.0|upper }}
                                </div>
                                <div>
                                    <div style="font-weight: 600;">{{ u.get_full_name|default:u.username }}</div>
                                    <div style="font-size: 11px; color: #666;">@{{ u.username }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div style="font-size: 13px;">{{ u.email }}</div>
                            <div style="font-size: 12px; color: var(--primary-yellow); font-weight: 600;">
                                {{ u.profile.phone_number|default:"-" }}
                            </div>
                        </td>
                        <td style="font-size: 12px; color: #666;">{{ u.date_joined|date:"d.m.Y" }}</td>
                        <td>
                            <span
                                style="background: #f0f0f0; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700;">
                                {{ u.cart_count }}
                            </span>
                        </td>
                        <td>
                            <span style="color: #ef4444; font-weight: 700;">
                                <i class="fas fa-heart"></i> {{ u.fav_count }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="admin-empty-state">
            <i class="fas fa-users"></i>
            <p>Mijozlar mavjud emas</p>
        </div>
        {% endif %}
    </div>

    <!-- Note Tab -->
    <div class="tab-content" id="note" style="display: none;">
        <div class="section-header">
            <div class="section-title">Eslatmalar</div>
        </div>
        <div class="admin-empty-state">
            <i class="far fa-sticky-note"></i>
            <p>Hozircha eslatmalar mavjud emas</p>
        </div>
    </div>

    <!-- Yangi Mahsulot Tab -->
    <div class="tab-content" id="qoshish" style="display: none;">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-plus-circle" style="color: var(--primary-yellow);"></i>
                Yangi mahsulot qo'shish
            </div>
        </div>

        <form action="{% url 'market:admin_add_product' %}" method="POST" enctype="multipart/form-data"
            class="admin-modern-form">
            {% csrf_token %}
            <div class="form-grid">
                <div class="form-group">
                    <label>Mahsulot nomi</label>
                    <input type="text" name="name" placeholder="Masalan: iPhone 15 Pro" required>
                </div>
                <div class="form-group">
                    <label>Kategoriya</label>
                    <select name="category" required>
                        <option value="">Tanlang...</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group full-width">
                    <label>Tavsif</label>
                    <textarea name="description" rows="4" placeholder="Mahsulot haqida batafsil ma'lumot..."
                        required></textarea>
                </div>
                <div class="form-group">
                    <label>Asosiy narx (so'm)</label>
                    <input type="number" name="price" placeholder="0" required>
                </div>
                <div class="form-group">
                    <label>Eski narx (optional)</label>
                    <input type="number" name="old_price" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Ombordagi soni</label>
                    <input type="number" name="stock" value="0" required>
                </div>
                <div class="form-group">
                    <label>Brend</label>
                    <input type="text" name="brand" placeholder="Masalan: Apple">
                </div>
                <div class="form-group full-width">
                    <label>Mahsulot rasmi</label>
                    <div class="file-upload-wrapper" onclick="document.getElementById('product_image_input').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Rasm yuklash uchun bosing</p>
                        <input type="file" name="image" id="product_image_input" accept="image/*" style="display: none;"
                            onchange="updateFileName(this)">
                        <div id="file-name-display"
                            style="margin-top: 10px; font-size: 12px; color: var(--primary-yellow);"></div>
                    </div>
                </div>
            </div>
            <div style="display: flex; justify-content: flex-end; margin-top: 30px;">
                <button type="submit" class="btn-yellow-main" style="padding: 12px 40px; font-size: 15px;">
                    <i class="fas fa-save"></i> Mahsulotni saqlash
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .admin-modern-form {
        background: #0a0a0a;
        padding: 30px;
        border-radius: 12px;
        border: 1px solid var(--admin-border);
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .form-group.full-width {
        grid-column: span 2;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 13px;
        color: #888;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        background: #111;
        border: 1px solid #222;
        padding: 12px;
        border-radius: 8px;
        color: white;
        outline: none;
        transition: 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        border-color: var(--primary-yellow);
        background: #151515;
    }

    .file-upload-wrapper {
        border: 2px dashed #333;
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: 0.2s;
    }

    .file-upload-wrapper:hover {
        border-color: var(--primary-yellow);
        background: rgba(255, 215, 0, 0.05);
    }

    .file-upload-wrapper i {
        font-size: 32px;
        color: #555;
        margin-bottom: 10px;
    }
</style>

<script>
    function updateFileName(input) {
        const display = document.getElementById('file-name-display');
        if (input.files && input.files[0]) {
            display.innerText = "Tanlangan fayl: " + input.files[0].name;
        }
    }
</script>

<script>
    // Tab switching logic improved
    const tabs = document.querySelectorAll('.admin-tab');
    const contents = document.querySelectorAll('.tab-content');

    // Default active tab based on context
    const defaultTab = 'tovar'; // Tovar boshqaruvi is now default active

    function switchTab(tabId) {
        tabs.forEach(t => {
            if (t.getAttribute('data-tab') === tabId) t.classList.add('active');
            else t.classList.remove('active');
        });
        contents.forEach(c => {
            if (c.id === tabId) c.style.display = 'block';
            else c.style.display = 'none';
        });
        localStorage.setItem('activeAdminTab', tabId);
    }

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const target = tab.getAttribute('data-tab');
            if (target) switchTab(target);
        });
    });

    // Multi-step form logic
    let currentStep = 1;
    const totalSteps = 6;

    function nextStep(n) {
        const steps = document.querySelectorAll('.form-step');

        // Hide current step
        steps[currentStep - 1].style.display = 'none';

        currentStep += n;

        if (currentStep > totalSteps) {
            document.getElementById('productForm').submit();
            return;
        }

        // Show new step
        steps[currentStep - 1].style.display = 'block';

        // Update UI
        document.getElementById('step-badge').innerText = `Bosqich ${currentStep}/${totalSteps}`;
        document.getElementById('prevBtn').style.display = currentStep > 1 ? 'block' : 'none';
        document.getElementById('nextBtn').innerText = currentStep === totalSteps ? 'Saqlash' : 'Davom etish';
    }

    // Initialize default tab from localStorage or use default
    const savedTab = localStorage.getItem('activeAdminTab');
    switchTab(savedTab || defaultTab);

    // Internal table search
    function filterTable(input, tableClass) {
        const val = input.value.toLowerCase();
        const rows = document.querySelectorAll('.' + tableClass + ' tbody tr');
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(val) ? '' : 'none';
        });
    }

    // Global search integration
    const globalSearch = document.getElementById('globalSearch');
    if (globalSearch) {
        globalSearch.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const activeTab = document.querySelector('.tab-content:not([style*="display: none"])');
            if (activeTab) {
                const rows = activeTab.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const text = row.innerText.toLowerCase();
                    row.style.display = text.includes(val) ? '' : 'none';
                });
            }
        });
    }

    // WebSocket for Real-time Orders
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const wsUrl = protocol + window.location.host + '/ws/orders/';

    // Notification Sound
    const notificationSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

    let reconnectDelay = 1000;
    const maxReconnectDelay = 30000;

    function connectWebSocket() {
        console.log("Connecting to WebSocket:", wsUrl);
        const chatSocket = new WebSocket(wsUrl);

        chatSocket.onopen = function (e) {
            console.log("WebSocket connection established");
            reconnectDelay = 1000;
            showToast("Tizimga ulandi (Real-time faol)", "#22c55e");
        };

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);

            if (data.type === 'user_update') {
                showToast(data.message, "#3b82f6");
                setTimeout(() => { location.reload(); }, 2000);
            } else {
                // Default handling for orders
                notificationSound.play().catch(e => console.log('Audio play failed:', e));
                showToast(data.message, "#ffae00");

                const counter = document.querySelector('.stat-card .value');
                if (counter) {
                    counter.innerText = parseInt(counter.innerText) + 1;
                }

                setTimeout(() => { location.reload(); }, 2000);
            }
        };

        chatSocket.onclose = function (e) {
            console.warn(`WebSocket closed. Reconnecting in ${reconnectDelay / 1000}s...`);
            showToast("Aloqa uzildi. Qayta ulanishga urinilmoqda...", "#ef4444");

            setTimeout(() => {
                connectWebSocket();
                reconnectDelay = Math.min(reconnectDelay * 2, maxReconnectDelay);
            }, reconnectDelay);
        };

        chatSocket.onerror = function (err) {
            console.error('WebSocket error:', err);
            chatSocket.close();
        };
    }

    // Start WebSocket
    connectWebSocket();

    // Helper for Toast
    function showToast(message, bgColor = '#22c55e') {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed; bottom: 20px; right: 20px; 
            background: ${bgColor}; color: white; padding: 15px 25px; 
            border-radius: 8px; z-index: 10000; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: opacity 0.3s;
        `;
        toast.innerText = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }
</script>
{% endblock %}